<!DOCTYPE html>
<html>
<head>
    <title>Teste Direto do Webhook</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe6e6; }
        .success { background: #e6ffe6; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Teste Direto do Webhook Evolution</h1>
    
    <h2>1. Testar chamada direta para evolution-webhook-v2</h2>
    <button onclick="testDirectWebhook()">Testar Webhook Direto</button>
    <div id="directResult" class="result"></div>

    <h2>2. Verificar configuração do webhook na Evolution</h2>
    <button onclick="checkWebhookConfig()">Verificar Configuração</button>
    <div id="configResult" class="result"></div>

    <h2>3. Reconfigurar webhook</h2>
    <button onclick="reconfigureWebhook()">Reconfigurar Webhook</button>
    <div id="reconfigResult" class="result"></div>

    <script>
        async function testDirectWebhook() {
            const resultDiv = document.getElementById('directResult');
            resultDiv.innerHTML = 'Testando webhook direto...';
            
            try {
                // Simular um payload típico do Evolution
                const testPayload = {
                    event: "MESSAGES_UPSERT",
                    instanceId: "teste",
                    data: {
                        key: {
                            remoteJid: "5547999999999@s.whatsapp.net",
                            fromMe: false,
                            id: "test123"
                        },
                        message: {
                            conversation: "Teste de mensagem"
                        },
                        messageTimestamp: Math.floor(Date.now() / 1000)
                    }
                };

                const response = await fetch('https://zldeaozqxjwvzgrblyrh.supabase.co/functions/v1/evolution-webhook-v2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Secret': 'sua-secret-aqui' // Você pode ajustar isso
                    },
                    body: JSON.stringify(testPayload)
                });

                const result = await response.text();
                resultDiv.innerHTML = `
                    <strong>Status:</strong> ${response.status}<br>
                    <strong>Response:</strong> ${result}
                `;
                resultDiv.className = response.ok ? 'result success' : 'result error';
            } catch (error) {
                resultDiv.innerHTML = `<strong>Erro:</strong> ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function checkWebhookConfig() {
            const resultDiv = document.getElementById('configResult');
            resultDiv.innerHTML = 'Verificando configuração...';
            
            try {
                const response = await fetch('https://evolution-evolution.upvzfg.easypanel.host/webhook/find/teste', {
                    method: 'GET',
                    headers: {
                        'apikey': '53BF9C125C14E977E85DB56879759',
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                resultDiv.innerHTML = `
                    <strong>Status:</strong> ${response.status}<br>
                    <strong>Configuração atual:</strong><br>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
                resultDiv.className = response.ok ? 'result success' : 'result error';
            } catch (error) {
                resultDiv.innerHTML = `<strong>Erro:</strong> ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function reconfigureWebhook() {
            const resultDiv = document.getElementById('reconfigResult');
            resultDiv.innerHTML = 'Reconfigurando webhook...';
            
            try {
                const response = await fetch('https://evolution-evolution.upvzfg.easypanel.host/webhook/set/teste', {
                    method: 'POST',
                    headers: {
                        'apikey': '53BF9C125C14E977E85DB56879759',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: "https://zldeaozqxjwvzgrblyrh.supabase.co/functions/v1/evolution-webhook-v2",
                        webhook_by_events: false,
                        webhook_base64: true,
                        events: ["QRCODE_UPDATED", "CONNECTION_UPDATE", "MESSAGES_UPSERT", "SEND_MESSAGE"]
                    })
                });

                const result = await response.json();
                resultDiv.innerHTML = `
                    <strong>Status:</strong> ${response.status}<br>
                    <strong>Resultado:</strong><br>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
                resultDiv.className = response.ok ? 'result success' : 'result error';
            } catch (error) {
                resultDiv.innerHTML = `<strong>Erro:</strong> ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
    </script>
</body>
</html>